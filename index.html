<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="favicon.png">
  <title>TWCUBEç¶²ç«™</title>
  <style>
    :root{
      --bg: #f8fafc; --card:#ffffff; --text:#0b1220; --accent:#06b6d4; --muted:#475569; --glass:rgba(11,17,32,0.03);
      --radius:12px;
      --discord-color: #5865F2; /* Discord å“ç‰Œè‰² */
      --facebook-color: #1877F2; /* Facebook å“ç‰Œè‰² */
      --warning: #facc15; /* è­¦å‘Šè‰² */
    }
    .dark{
      --bg:#071024; --card:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --text:#e6eef6; --accent:#06b6d4; --muted:#94a3b8; --glass:rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial}
    body{background:var(--bg);color:var(--text);display:flex;align-items:flex-start;justify-content:center;padding:24px}
    .container{width:100%;max-width:980px}

    /* 1. å¡ç‰‡è¼‰å…¥å‹•ç•« */
    @keyframes fadeInSlideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .card{
        background:var(--card);
        border:1px solid rgba(0,0,0,0.04);
        padding:20px;
        border-radius:var(--radius);
        box-shadow:0 8px 30px rgba(2,6,23,0.08);
        animation: fadeInSlideUp 0.6s ease-out forwards;
        opacity: 0;
        margin-bottom: 20px;
    }
    .dark .card{box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04)}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    
    input,button,select{
        padding:10px 12px;
        border-radius:8px;
        border:1px solid rgba(0,0,0,0.06);
        background:transparent;
        color:inherit;
        font-size:14px;
        transition: all 0.2s ease;
    }
    .dark input,.dark button,.dark select{border:1px solid rgba(255,255,255,0.04)}
    input[type=text]{flex:1;min-width:200px}

    input[type=text]:focus, select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        outline: none;
    }
    button:hover {
        background: var(--glass);
        transform: translateY(-1px);
    }
    button:active {
        transform: translateY(0);
        box-shadow: none;
    }

    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .results{margin-top:12px}
    .year-group{margin-top:12px}
    
    /* 3. å¹´åˆ†æ¨™é¡Œçš„å‹•ç•« */
    @keyframes slideInYear {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .year-title{
        font-weight:700;margin:12px 0 6px;
        display:flex;align-items:center;gap:8px;
        animation: slideInYear 0.4s ease-out forwards; 
        opacity: 0;
    }

    /* 2. åˆ—è¡¨é …ç›®æ‡¸åœæ•ˆæœ */
    .item{
        padding:12px;
        border-radius:8px;
        background:var(--glass);
        border:1px solid rgba(0,0,0,0.03);
        display:grid;
        grid-template-columns:1fr auto;
        gap:8px;
        align-items:center;
        margin-bottom:8px;
        cursor: pointer; 
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .item:hover {
        transform: translateY(-2px) scale(1.005); 
        box-shadow: 0 10px 20px rgba(2,6,23,0.1); 
        border-color: var(--accent); 
    }
    .dark .item{border:1px solid rgba(255,255,255,0.02)}
    .dark .item:hover {
        box-shadow: 0 10px 20px rgba(2,6,23,0.8);
        border-color: var(--accent);
    }

    .meta{color:var(--muted);font-size:13px}
    .link{color:var(--accent);text-decoration:none}
    .small{font-size:13px;color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    
    .icon-btn{
        width:36px; height:36px; border-radius:8px; display:inline-flex;
        align-items:center; justify-content:center; cursor:pointer;
        border:1px solid rgba(0,0,0,0.06); background:transparent;
        transition: transform 0.2s ease, background 0.2s ease;
    }
    .dark .icon-btn{border:1px solid rgba(255,255,255,0.04)}
    .icon-btn:active { transform: rotate(15deg); background: var(--glass); }

    .countdown{margin-top:4px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
    .light-lamp{width:10px;height:10px;border-radius:50%;display:inline-block}
    .green{background:#22c55e}
    .yellow{background:#eab308}
    .red{background:#ef4444}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    
    /* 4. ç‹€æ…‹è¨Šæ¯çš„æ·¡å…¥æ·¡å‡º */
    .status{
        margin-top:8px; color:var(--muted); font-size:13px; opacity: 1;
        transition: opacity 0.3s ease;
    }
    .status.fade-out { opacity: 0; }

    /* 5. Modal æ¨£å¼ */
    .modal-backdrop {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); z-index: 1000;
      display: none; opacity: 0; transition: opacity 0.3s ease;
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: var(--card); padding: 30px; border-radius: var(--radius);
      width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      transform: scale(0.9); transition: transform 0.3s ease;
    }
    .modal-backdrop.is-open { display: flex; opacity: 1; }
    .modal-backdrop.is-open .modal-content { transform: scale(1); }
    .dark .modal-content{box-shadow: 0 10px 40px rgba(0,0,0,0.8);}
    .modal-title {font-size: 24px; margin-top: 0; margin-bottom: 15px;}
    .modal-info div {margin-bottom: 8px; font-size: 15px; line-height: 1.4;}
    .modal-info strong {font-weight: 600; color: var(--text);}
    .modal-close-btn {
      position: absolute; top: 15px; right: 15px; background: none; border: none;
      font-size: 24px; cursor: pointer; color: var(--muted); transition: color 0.2s;
    }
    .modal-close-btn:hover {color: var(--text);}
    .modal-link-btn {
        display: block; width: 100%; text-align: center; margin-top: 20px;
        padding: 10px; background: var(--accent); color: white; border-radius: 8px;
        text-decoration: none; font-weight: 600; transition: background-color 0.2s ease;
    }
    .modal-link-btn:hover { background: #0097a7; }

    /* 6. è¯çµ¡è³‡è¨Šå€å¡Šæ¨£å¼ - çªå‡ºå€‹äººè³‡è¨Š */
    .contact-panel {
        padding: 15px 0;
    }
    .contact-group {
        margin-bottom: 25px;
        padding: 20px;
        border-radius: var(--radius);
        background: var(--glass);
        border: 2px solid var(--accent); /* çªå‡ºé‚Šæ¡† */
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.1);
    }
    .dark .contact-group {
        border: 2px solid var(--accent);
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }
    .contact-title {
        font-size: 20px;
        font-weight: 700;
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--accent);
    }
    .info-item {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        font-size: 16px;
        padding: 8px 0;
        border-bottom: 1px dashed rgba(0,0,0,0.1);
    }
    .dark .info-item {
        border-bottom: 1px dashed rgba(255,255,255,0.1);
    }
    .info-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
    }
    .info-item i {
        font-size: 20px;
        color: var(--muted);
    }
    .info-item a {
        color: var(--text);
        text-decoration: none;
        font-weight: 600;
        word-break: break-all;
    }
    .info-item a:hover {
        color: var(--accent);
    }

    /* 9. æ–°å¢çš„å‚™è¨»æ¨£å¼ */
    .note-box {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        background: rgba(250, 204, 21, 0.1); /* æ·ºé»ƒè‰²èƒŒæ™¯ */
        border-left: 5px solid var(--warning);
        color: var(--text);
        font-size: 14px;
        font-weight: 500;
        line-height: 1.5;
    }
    .dark .note-box {
        background: rgba(250, 204, 21, 0.05);
    }
    
    /* 7. Tab å°èˆªæ¨£å¼ */
    .tab-nav { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab-button {
        padding: 10px 15px; border: none; background: var(--glass);
        color: var(--muted); font-weight: 600; cursor: pointer;
        border-radius: var(--radius) var(--radius) 0 0;
        border-bottom: 3px solid transparent; transition: all 0.2s ease;
    }
    .tab-button.active {
        background: var(--card); color: var(--accent);
        border-bottom: 3px solid var(--accent);
        box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
    }

    /* 8. Tab å…§å®¹æ¨£å¼ */
    .tab-content {
        display: none;
        min-height: 300px;
    }
    .tab-content.active { display: block; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4C0A/Q3w7aN33yFz5q81Hk+f/8x/vU4v9i93cT3N2Jz4XyFq7O7Qp5K+fQ95TzE8P/vA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<div class="container">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h1>TWCUBEç¶²ç«™</h1>
        <p class="lead">WCA å°ç£æ¯”è³½èˆ‡å€‹äººè¯çµ¡è³‡æº ğŸ‡¹ğŸ‡¼</p>
      </div>
      <div class="toolbar">
        <div title="ç™½ç´ ä¸»é¡Œï¼ˆå¤ªé™½ï¼‰" id="sunBtn" class="icon-btn">â˜€ï¸</div>
        <div title="æ·±è‰²ä¸»é¡Œï¼ˆæœˆäº®ï¼‰" id="moonBtn" class="icon-btn">ğŸŒ™</div>
      </div>
    </div>

    <div class="tab-nav" id="tabNav">
        <button class="tab-button active" data-tab="competitions">ğŸ—“ï¸ æ¯”è³½æŸ¥è©¢</button>
        <button class="tab-button" data-tab="contact">ğŸ“ è¯çµ¡è³‡è¨Š</button>
    </div>
    
    <div id="competitionsPanel" class="tab-content active">
        <h2>WCA è³½äº‹åˆ—è¡¨ (å°ç£)</h2>
        <div class="controls">
          <input id="q" type="text" placeholder="æœå°‹åç¨± / åŸå¸‚ / å¹´ä»½ / ä»£ç¢¼ï¼ˆæ¨¡ç³Šæœå°‹ï¼‰" />
          <button id="clearBtn" type="button">æ¸…é™¤</button>
        </div>

        <div id="status" class="status">è¼‰å…¥ä¸­â€¦</div>
        <div id="results" class="results"></div>

        <footer>
          å°æé†’ï¼šé»æ“Šæ¯”è³½å¯æŸ¥çœ‹è©³ç´°è³‡è¨Šï¼Œå€’æ•¸ä»¥æ¯”è³½é–‹å§‹æ—¥ç‚ºåŸºæº–ã€‚
        </footer>
    </div>

    <div id="contactPanel" class="tab-content">
        <h2>å»ºç«‹è€…å€‹äººè¯çµ¡æ–¹å¼</h2>
        
        <div class="contact-panel">

            <div class="contact-group">
                <div class="contact-title">ç¶²ç«™å»ºç«‹èˆ‡ç¶­è­·è€…</div>
                
                <div class="info-item">
                    <i class="fab fa-discord" style="color: #5865F2;"></i>
                    <span>Discord é‚€è«‹é€£çµï¼š
                        <a href="https://discord.gg/y2gxYtmXp7" target="_blank">
                            https://discord.gg/y2gxYtmXp7
                        </a>
                    </span>
                </div>
                
                <div class="info-item">
                    <i class="far fa-envelope" style="color: #ea4335;"></i>
                    <span>Gmail é›»å­éƒµä»¶ï¼š
                        <a href="mailto:swxhzop@gmail.com">
                            swxhzop@gmail.com
                        </a>
                    </span>
                </div>
                
                <div class="note-box">
                    âš ï¸ å‚™è¨»ï¼šæœ¬ç«™ç¶­è­·è€…ç‚ºä¸€åå­¸ç”Ÿï¼Œå› æ­¤å›è¦†å¯èƒ½æœƒæ¯”è¼ƒæ…¢ã€‚<br>
                    **å»ºè­°ä½¿ç”¨ Discord è¯çµ¡ï¼Œæœƒæ¯”è¼ƒå¿«é€Ÿå¾—åˆ°å›è¦†ã€‚**
                </div>
            </div>

            <p class="small" style="margin-top: 20px; color: var(--muted);">
                å¦‚æœæ‚¨å°æœ¬ç¶²ç«™æœ‰ä»»ä½•å»ºè­°ã€åˆä½œæ„å‘æˆ–æŠ€è¡“å•é¡Œï¼Œæ­¡è¿é€éä»¥ä¸Šæ–¹å¼è¯çµ¡ã€‚
            </p>
            
        </div>
    </div>

  </div>
</div>

<div id="compModalBackdrop" class="modal-backdrop">
  <div id="compModal" class="modal-content" style="position: relative;">
    <button id="modalCloseBtn" class="modal-close-btn" title="é—œé–‰è¦–çª—">Ã—</button>
    <h2 id="modalTitle" class="modal-title">æ¯”è³½åç¨±</h2>
    <div id="modalInfo" class="modal-info">
      </div>
    <a id="modalLink" class="modal-link-btn" href="#" target="_blank">å‰å¾€ WCA è©³ç´°é é¢ â†’</a>
  </div>
</div>


<script>
const API_BASE_COMP='https://www.worldcubeassociation.org/api/v0/competitions';

// WCA é …ç›®åç¨±æ˜ å°„
const WCA_EVENTS = {
    '333': 'ä¸‰éš (3x3x3)', '222': 'äºŒéš (2x2x2)', '444': 'å››éš (4x4x4)', '555': 'äº”éš (5x5x5)',
    '666': 'å…­éš (6x6x6)', '777': 'ä¸ƒéš (7x7x7)', '333bf': 'ä¸‰éšç›²è§£', '333fm': 'æœ€å°‘æ­¥',
    '333oh': 'å–®æ‰‹', 'minx': 'äº”é­”æ–¹', 'pyram': 'é‡‘å­—å¡”', 'sq1': 'SQ-1',
    'clock': 'é­”éŒ¶ (Clock)', 'skewb': 'æ–œè½‰ (Skewb)', '444bf': 'å››éšç›²è§£', '555bf': 'äº”éšç›²è§£'
};

// æ¯”è³½æŸ¥è©¢ DOM
const qEl=document.getElementById('q');
const resultsEl=document.getElementById('results');
const statusEl=document.getElementById('status');
const clearBtn=document.getElementById('clearBtn');

// Tab DOM
const tabNavEl = document.getElementById('tabNav');
const competitionsPanelEl = document.getElementById('competitionsPanel');
const contactPanelEl = document.getElementById('contactPanel'); // è¯çµ¡è³‡è¨Šé¢æ¿

// ä¸»é¡Œ DOM
const sunBtn=document.getElementById('sunBtn');
const moonBtn=document.getElementById('moonBtn');

// Modal DOM
const modalBackdrop = document.getElementById('compModalBackdrop');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const modalTitle = document.getElementById('modalTitle');
const modalInfo = document.getElementById('modalInfo');
const modalLink = document.getElementById('modalLink');


// ----------------------------------------------------------------
// --- Tab & é€šç”¨åŠŸèƒ½ ---
// ----------------------------------------------------------------

function switchTab(targetTab) {
    // ç§»é™¤æ‰€æœ‰ Tab æŒ‰éˆ•å’Œå…§å®¹çš„ active ç‹€æ…‹
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // è¨­å®šç›®æ¨™ Tab ç‚º active
    const targetBtn = document.querySelector(`.tab-button[data-tab="${targetTab}"]`);
    if (targetBtn) targetBtn.classList.add('active');

    if (targetTab === 'competitions') {
        competitionsPanelEl.classList.add('active');
        statusEl.textContent = cache ? `å·²è¼‰å…¥ ${cache.length} ç­†æ¯”è³½è³‡æ–™ã€‚` : 'è¼‰å…¥ä¸­â€¦';
    } else if (targetTab === 'contact') {
        contactPanelEl.classList.add('active');
    }
}

tabNavEl.addEventListener('click', (e) => {
    if (e.target.classList.contains('tab-button')) {
        switchTab(e.target.dataset.tab);
    }
});

// ----------------------------------------------------------------
// --- æ¯”è³½æŸ¥è©¢åŠŸèƒ½ (Modal/Countdown) ---
// ----------------------------------------------------------------

function formatDateRange(start,end){
Â  try{
Â  Â  const s=new Date(start).toLocaleDateString();
Â  Â  const e=new Date(end).toLocaleDateString();
Â  Â  return s===e?s:`${s} â€” ${e}`;
Â  }catch(e){return start||''}
}

async function showModal(c) {
Â  Â  modalTitle.textContent = c.name;
Â  Â  modalInfo.innerHTML = `
Â  Â  Â  Â  <div><strong>åœ°é»ï¼š</strong> ${c.city}, ${c.country_name}</div>
Â  Â  Â  Â  <div><strong>ä»£ç¢¼ï¼š</strong> ${c.id}</div>
Â  Â  Â  Â  <div><strong>æ—¥æœŸï¼š</strong> ${formatDateRange(c.start_date, c.end_date)}</div>
Â  Â  Â  Â  <div><strong>ä¸»è¾¦æ–¹ï¼š</strong> ${c.organizer || c.organizer_name || '-'}</div>
Â  Â  Â  Â  <div><strong>ç‹€æ…‹ï¼š</strong> ${c.registration_open ? 'âœ… å ±åé–‹æ”¾ä¸­' : 'âŒ å ±åå°šæœªé–‹æ”¾'}</div>
Â  Â  Â  Â  <div id="modalRecordStatus" style="margin-top: 15px; border-top: 1px solid var(--glass); padding-top: 10px;">
Â  Â  Â  Â  Â  <strong>ç´€éŒ„æ©Ÿæœƒï¼š</strong> è¼‰å…¥ä¸­...
Â  Â  Â  Â  </div>
Â  Â  `;
Â  Â  modalLink.href = `https://www.worldcubeassociation.org/competitions/${c.id}`;
Â  Â  
Â  Â  // é¡¯ç¤º Modal
Â  Â  modalBackdrop.classList.add('is-open');
Â  Â  document.body.style.overflow = 'hidden';

Â  Â  // *** Google æœç´¢åˆ¤æ–·ç´€éŒ„æ©Ÿæœƒ ***
Â  Â  const recordStatusEl = document.getElementById('modalRecordStatus');
Â  Â  
Â  Â  let statusText = 'ğŸ† <strong>åœ‹å®¶ç´€éŒ„ (NR)</strong>ï¼šå¯æŒ‘æˆ°'; 
Â  Â  let hasWR = false;

Â  Â  const query = `${c.name} WCA competition type`; 
    // å‘¼å« Google æœå°‹å·¥å…·
Â  Â  try {
Â  Â  Â  Â  const searchResult = await google.search([query]);
Â  Â  Â  Â  const snippet = searchResult.snippets.map(s => s.toLowerCase()).join(' ');

Â  Â  Â  Â  if (snippet.includes('world championship') || snippet.includes('wr') || c.name.toLowerCase().includes('world championship')) {
Â  Â  Â  Â  Â  Â  hasWR = true;
Â  Â  Â  Â  } else if (snippet.includes('continental championship') || snippet.includes('asian championship') || snippet.includes('cr')) {
Â  Â  Â  Â  Â  Â  statusText += '<br>ğŸŒ <strong>æ´²éš›ç´€éŒ„ (CR)</strong>ï¼šå¯æŒ‘æˆ°';
Â  Â  Â  Â  }

Â  Â  Â  Â  if (hasWR) {
Â  Â  Â  Â  Â  Â  statusText = 'ğŸ‘‘ <strong>ä¸–ç•Œç´€éŒ„ (WR)</strong>ï¼šå¯æŒ‘æˆ°<br>' + statusText;
Â  Â  Â  Â  }

Â  Â  Â  Â  recordStatusEl.innerHTML = `<strong>ç´€éŒ„æ©Ÿæœƒï¼š</strong><br>${statusText}`;

Â  Â  } catch (e) {
Â  Â  Â  Â  recordStatusEl.innerHTML = `<strong>ç´€éŒ„æ©Ÿæœƒï¼š</strong><br>${statusText} <span class="small">(è©³ç´°è³‡è¨Šè¼‰å…¥å¤±æ•—)</span>`;
Â  Â  }
}

function closeModal() {
Â  Â  modalBackdrop.classList.remove('is-open');
Â  Â  document.body.style.overflow = ''; 
}

// é—œé–‰ Modal çš„äº‹ä»¶ç›£è½å™¨
modalCloseBtn.addEventListener('click', closeModal);
modalBackdrop.addEventListener('click', (e) => {
Â  Â  if (e.target === modalBackdrop) {
Â  Â  Â  Â  closeModal();
Â  Â  }
});
document.addEventListener('keydown', (e) => {
Â  Â  if (e.key === 'Escape' && modalBackdrop.classList.contains('is-open')) {
Â  Â  Â  Â  closeModal();
Â  Â  }
});


function renderItem(c){
Â  const div=document.createElement('div');
Â  div.className='item';
Â  
Â  div.addEventListener('click', () => showModal(c));

Â  const left=document.createElement('div');
Â  left.innerHTML=`<div style="font-weight:600">${c.name}</div>
Â  <div class="meta">${c.city||'-'}, ${c.country_name||'-'} â€¢ ${formatDateRange(c.start_date,c.end_date)}</div>
Â  <div class="small">ä¸»è¾¦ï¼š${c.organizer||c.organizer_name||'-'}</div>`;

Â  const cdDiv=document.createElement('div');
Â  cdDiv.className='countdown';
Â  const lamp=document.createElement('span');
Â  lamp.className='light-lamp';
Â  const start=new Date(c.start_date);
Â  const end=new Date(c.end_date);

Â  function updateCountdown(){
Â  Â  const now=new Date();
Â  Â  if (now > end) {
Â  Â  Â  lamp.className='light-lamp red';
Â  Â  Â  cdDiv.textContent='æ¯”è³½å·²çµæŸ';
Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  if(c.registration_open){
Â  Â  Â  lamp.className='light-lamp green';
Â  Â  Â  const diff=start-now;
Â  Â  Â  if(diff>0){
Â  Â  Â  Â  const d=Math.floor(diff/86400000);
Â  Â  Â  Â  const h=Math.floor(diff%86400000/3600000);
Â  Â  Â  Â  const m=Math.floor(diff%3600000/60000);
Â  Â  Â  Â  const s=Math.floor(diff%60000/1000);
Â  Â  Â  Â  cdDiv.textContent=`è·é›¢æ¯”è³½é–‹å§‹ï¼š${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
Â  Â  Â  }else{
Â  Â  Â  Â  lamp.className='light-lamp green';
Â  Â  Â  Â  cdDiv.textContent='æ¯”è³½é€²è¡Œä¸­';
Â  Â  Â  }
Â  Â  }else{
Â  Â  Â  const diff=start-now;
Â  Â  Â  if(diff>0){
Â  Â  Â  Â  if(diff<3*86400000){lamp.className='light-lamp yellow';}
Â  Â  Â  Â  else{lamp.className='light-lamp red';} 
Â  Â  Â  Â  
Â  Â  Â  Â  const d=Math.floor(diff/86400000);
Â  Â  Â  Â  const h=Math.floor(diff%86400000/3600000);
Â  Â  Â  Â  const m=Math.floor(diff%3600000/60000);
Â  Â  Â  Â  const s=Math.floor(diff%60000/1000);
Â  Â  Â  Â  cdDiv.textContent=`è·é›¢æ¯”è³½é–‹å§‹ï¼š${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
Â  Â  Â  }else{
Â  Â  Â  Â  lamp.className='light-lamp red';
Â  Â  Â  Â  cdDiv.textContent='å ±åå·²æˆªæ­¢/å·²çµæŸ';
Â  Â  Â  }
Â  Â  }
Â  Â  cdDiv.prepend(lamp);
Â  }
Â  updateCountdown();
Â  const intervalId = setInterval(updateCountdown, 1000);
Â  
Â  div.cleanup = () => clearInterval(intervalId);


Â  div.appendChild(left);
Â  div.appendChild(cdDiv);
Â  
Â  const right=document.createElement('div');
Â  right.style.width = '100px'; 
Â  right.style.textAlign = 'right';
Â  right.innerHTML=`<span class="small" style="color:var(--accent); display:block;">é»æ“Šçœ‹è©³æƒ…</span>`; 
Â  div.appendChild(right);
Â  
Â  return div;
}

function groupByYear(data){
Â  const groups={};
Â  data.forEach(c=>{
Â  Â  const year=c.start_date?new Date(c.start_date).getFullYear():'æœªçŸ¥';
Â  Â  if(!groups[year]) groups[year]=[];
Â  Â  groups[year].push(c);
Â  });
Â  const sortedYears=Object.keys(groups).sort((a,b)=>b-a);
Â  return {groups,sortedYears};
}

async function fetchAllTaiwanCompetitions(){
  statusEl.classList.add('fade-out');
  await new Promise(r => setTimeout(r, 300));

  statusEl.textContent='æ­£åœ¨å¾ WCA å–å¾—å°ç£æ¯”è³½ï¼ˆé€é æŠ“å–â€¦ï¼‰';
  statusEl.classList.remove('fade-out');
  let page=1; const per_page=100; let all=[];
  try{
    while(true){
      // æ³¨æ„ï¼šä½¿ç”¨ API_BASE_COMP
      const url=`${API_BASE_COMP}?country_iso2=TW&per_page=${per_page}&page=${page}`;
      const res=await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json();
      if(!Array.isArray(data)||data.length===0) break;
      all=all.concat(data);
      statusEl.textContent=`å·²å–å¾— ${all.length} ç­†ï¼ˆç¬¬ ${page} é ï¼‰...`;
      if(data.length<per_page) break;
      page+=1;
      await new Promise(r=>setTimeout(r,150));
    }
    statusEl.classList.add('fade-out');
    await new Promise(r => setTimeout(r, 300));
    statusEl.textContent=`å…¨éƒ¨è¼‰å…¥å®Œæˆï¼Œå…± ${all.length} ç­†è³‡æ–™ã€‚`;
    statusEl.classList.remove('fade-out');
    return all;
  }catch(err){
    statusEl.classList.add('fade-out');
    await new Promise(r => setTimeout(r, 300));
    console.error(err); 
    statusEl.textContent='ç„¡æ³•å®Œæ•´å–å¾— WCA APIï¼š'+err.message; 
    statusEl.classList.remove('fade-out');
    throw err;
  }
}

let cache=null;

function renderGroups(groupsObj,q){
Â  Array.from(resultsEl.querySelectorAll('.item')).forEach(item => {
Â  Â  if (item.cleanup) item.cleanup();
Â  });
Â  
Â  resultsEl.innerHTML='';
Â  const {groups,sortedYears}=groupsObj;
Â  sortedYears.forEach((year, yearIndex)=>{
Â  Â  const yearDiv=document.createElement('div'); yearDiv.className='year-group';
Â  Â  const title=document.createElement('div'); 
Â  Â  title.className='year-title'; 
Â  Â  title.innerHTML=`ğŸ“… ${year} å¹´`;
Â  Â  title.style.animationDelay = `${yearIndex * 0.1}s`; 
Â  Â  yearDiv.appendChild(title);
Â  Â  const list=document.createElement('div');
Â  Â  const items=groups[year].filter(c=>{
Â  Â  Â  if(!q) return true;
Â  Â  Â  const ql=q.toLowerCase();
Â  Â  Â  return (c.name&&c.name.toLowerCase().includes(ql))||(c.city&&c.city.toLowerCase().includes(ql))||(c.id&&c.id.toLowerCase().includes(ql))||(c.start_date&&new Date(c.start_date).getFullYear().toString().includes(ql));
Â  Â  });
Â  Â  if(items.length===0){
Â  Â  Â  const none=document.createElement('div'); none.className='small'; none.textContent='ï¼ˆç„¡ç¬¦åˆé …ç›®ï¼‰'; list.appendChild(none);
Â  Â  }else{
Â  Â  Â  items.sort((a,b)=>new Date(b.start_date)-new Date(a.start_date)).forEach(c=>list.appendChild(renderItem(c)));
Â  Â  }
Â  Â  yearDiv.appendChild(list);
Â  Â  resultsEl.appendChild(yearDiv);
Â  });
}

let searchTimer=null;
function liveSearch(){
Â  const q=qEl.value.trim();
Â  if(!cache) return;
Â  clearTimeout(searchTimer);
Â  searchTimer=setTimeout(async ()=>{
Â  Â  statusEl.classList.add('fade-out');
Â  Â  await new Promise(r => setTimeout(r, 300));

Â  Â  renderGroups(groupByYear(cache),q); 
Â  Â  const filteredCount = Array.from(resultsEl.querySelectorAll('.item')).length;
Â  Â  statusEl.textContent=`å·²éæ¿¾å‡º ${filteredCount} ç­†çµæœï¼ˆæœå°‹ï¼š\"${q||'å…¨éƒ¨'}\"ï¼‰`;
Â  Â  statusEl.classList.remove('fade-out');
Â  },180);
}

qEl.addEventListener('input',liveSearch);
clearBtn.addEventListener('click',async ()=>{
Â  Â  qEl.value=''; qEl.focus(); 
Â  Â  if(cache){
Â  Â  Â  Â  statusEl.classList.add('fade-out');
Â  Â  Â  Â  await new Promise(r => setTimeout(r, 300));

Â  Â  Â  Â  renderGroups(groupByYear(cache),''); 
Â  Â  Â  Â  statusEl.textContent=`å·²æ¸…é™¤ç¯©é¸ï¼Œå…± ${cache.length} ç­†è³‡æ–™ã€‚`;
Â  Â  Â  Â  statusEl.classList.remove('fade-out');
Â  Â  }
});


// ----------------------------------------------------------------
// --- åˆå§‹åŒ–èˆ‡ä¸»é¡Œåˆ‡æ› ---
// ----------------------------------------------------------------

(async()=>{
  // 1. è¼‰å…¥æ¯”è³½è³‡æ–™
  cache=await fetchAllTaiwanCompetitions();
  const seen=new Set();
  // éæ¿¾é‡è¤‡çš„æ¯”è³½ID
  cache=cache.filter(c=>{if(seen.has(c.id)) return false; seen.add(c.id); return true;});
  renderGroups(groupByYear(cache),'');

  // 2. é è¨­é¡¯ç¤ºæ¯”è³½é¢æ¿
  switchTab('competitions'); 
})();
</script>
</body>
</html>
