<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TWCUBE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4C0A/Q3w7aN33yFz5q81Hk+f/8x/vU4v9i93cT3N2Jz4XyFq7O7Qp5K+f/8x/vU4v9i93cT3N2Jz4XyFq7O7Qp5K+fQ95TzE8P/vA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0b1220;
            --accent: #06b6d4;
            --muted: #475569;
            --glass: rgba(11, 17, 32, 0.03);
            --radius: 12px;
            --warning: #facc15;
            --shadow: 0 8px 30px rgba(2, 6, 23, 0.08);
        }

        [data-theme="dark"] {
            --bg: #071024;
            --card: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            --text: #e6eef6;
            --accent: #06b6d4;
            --muted: #94a3b8;
            --glass: rgba(255, 255, 255, 0.03);
            --shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            background: var(--bg);
            color: var(--text);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 24px;
        }

        .container {
            width: 100%;
            max-width: 980px;
        }

        /* Card & Animation */
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card);
            border: 1px solid rgba(0, 0, 0, 0.04);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            animation: fadeInSlideUp 0.6s ease-out forwards;
            opacity: 0;
            margin-bottom: 20px;
        }

        [data-theme="dark"] .card { border: 1px solid rgba(255, 255, 255, 0.04); }
        h1 { margin: 0 0 8px; font-size: 20px; }
        p.lead { margin: 0 0 18px; color: var(--muted); }

        /* Controls & Inputs */
        input, button, select {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            background: transparent;
            color: inherit;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        [data-theme="dark"] input, [data-theme="dark"] button, [data-theme="dark"] select { border: 1px solid rgba(255, 255, 255, 0.04); }
        input[type=text]:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
            outline: none;
        }

        button:hover { background: var(--glass); transform: translateY(-1px); }
        button:active { transform: translateY(0); box-shadow: none; }
        .controls { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }

        /* Icon Buttons */
        .icon-btn {
            width: 36px; height: 36px; border-radius: 8px; display: inline-flex;
            align-items: center; justify-content: center; cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.06); background: transparent;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        [data-theme="dark"] .icon-btn { border: 1px solid rgba(255, 255, 255, 0.04); }
        .icon-btn:active { transform: rotate(15deg); background: var(--glass); }

        /* Tab Navigation */
        .tab-nav { display: flex; gap: 5px; margin-bottom: 0; border-bottom: 1px solid var(--glass); }
        .tab-button {
            padding: 10px 15px; border: none; background: var(--glass);
            color: var(--muted); font-weight: 600; cursor: pointer;
            border-radius: var(--radius) var(--radius) 0 0;
            border-bottom: 3px solid transparent; transition: all 0.2s ease;
            margin-bottom: -1px;
        }

        .tab-button.active {
            background: var(--card); color: var(--accent);
            border: 1px solid var(--glass); border-bottom: 1px solid var(--card);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05); z-index: 10;
        }

        [data-theme="dark"] .tab-button.active { border-bottom: 1px solid var(--bg); }
        .tab-content { display: none; min-height: 300px; padding-top: 5px; }
        .tab-content.active { display: block; }

        /* WCA List Styles */
        .item {
            padding: 12px;
            border-radius: 8px;
            background: var(--glass);
            border: 1px solid rgba(0, 0, 0, 0.03);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .item:hover {
            transform: translateY(-2px) scale(1.005);
            box-shadow: 0 10px 20px rgba(2, 6, 23, 0.1);
            border-color: var(--accent);
        }

        .meta { color: var(--muted); font-size: 13px }
        .small { font-size: 13px; color: var(--muted) }
        
        /* WCA List Year Grouping Styles */
        .year-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--glass);
            display: inline-block;
            opacity: 0;
            animation: fadeInSlideUp 0.6s ease-out forwards;
        }
        .year-group {
            margin-bottom: 30px;
        }

        /* Countdown Lamp */
        .light-lamp {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%; 
            margin-right: 5px; animation: pulse 1.5s infinite;
        }
        .light-lamp.red { background-color: #dc2626; box-shadow: 0 0 5px #dc2626; }
        .light-lamp.green { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .light-lamp.yellow { background-color: #facc15; box-shadow: 0 0 5px #facc15; }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* Timer Styles */
        #timerContainer {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 40px 20px; margin-bottom: 20px; border-radius: var(--radius);
            border: 1px solid var(--glass); transition: all 0.3s ease;
        }

        @keyframes timer-digit-pop { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes button-press-feedback {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
            50% { transform: scale(0.99); box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }

        #timerDisplay {
            font-size: 80px; font-weight: 200; color: var(--text);
            margin: 0 0 10px 0; font-family: monospace;
            transition: color 0.1s ease-out, transform 0.05s ease-out;
        }

        #timerDisplay.ready { color: #22c55e; /* ç¶ è‰² */ }
        #timerStatus { color: var(--muted); opacity: 1; transition: opacity 0.3s ease; }
        #timerStatus.fade-out { opacity: 0; }
        #timerContainer.key-pressed { animation: button-press-feedback 0.3s ease-out forwards; }

        /* Score List Styles */
        .time-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; margin-bottom: 6px; border-radius: 6px;
            background: var(--glass); font-weight: 500; transition: background 0.2s ease;
        }
        .time-item:hover { background: rgba(6, 182, 212, 0.05); }
        .time-item .rank { color: var(--accent); font-weight: 700; width: 30px; }
        .time-item .value { flex-grow: 1; font-size: 18px; text-align: right; font-family: monospace; }
        .time-item.best { border: 1px solid var(--warning); background: rgba(250, 204, 21, 0.1); }
        .clear-btn-red {
            background-color: #dc2626; color: white; border: none; padding: 8px 15px;
            border-radius: 8px; cursor: pointer; font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .clear-btn-red:hover { background-color: #b91c1c; }

        /* Contact Panel Styles */
        .contact-group {
            padding: 20px; 
            border-radius: var(--radius); 
            background: var(--glass);
        }
        .contact-title {
            font-weight: 600; 
            font-size: 16px; 
            margin-bottom: 15px; 
            border-bottom: 1px solid var(--glass); 
            padding-bottom: 5px;
        }
        .info-item {
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .info-item a {
            color: var(--accent); 
            text-decoration: none;
        }
        .note-box {
            margin-top: 15px; 
            padding: 10px; 
            background: rgba(250, 204, 21, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--warning); 
            font-size: 13px;
        }


        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center;
            align-items: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-backdrop.is-open { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--card); padding: 30px; border-radius: var(--radius);
            max-width: 500px; width: 90%; transform: scale(0.9); transition: transform 0.3s ease;
            border: 3px solid var(--warning);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), 0 0 15px var(--warning);
        }

        .modal-backdrop.is-open .modal-content { transform: scale(1); }
        .modal-close-btn {
            position: absolute; top: 10px; right: 10px; background: var(--glass);
            border: 1px solid var(--muted); border-radius: 4px; width: 30px; height: 30px;
            font-size: 18px; cursor: pointer; color: var(--muted); line-height: 1;
        }

        .modal-title {
            font-size: 24px; font-weight: 700; margin-bottom: 20px;
            color: var(--warning); padding-bottom: 5px; border-bottom: 1px solid var(--glass);
        }
        .modal-link-btn {
             display: inline-block; background-color: var(--accent); color: white; padding: 8px 15px; 
             border-radius: 8px; text-decoration: none; margin-top: 20px; 
             transition: background-color 0.2s ease;
        }
        .modal-link-btn:hover { background-color: #0d9488; }
    </style>
</head>

<body>

    <div class="container">

        <div class="card">

            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
                <div>
                    <h1>TWCUBEç¶²ç«™</h1>
                    <p class="lead">WCA å°ç£æ¯”è³½ ğŸ‡¹ğŸ‡¼</p>
                </div>
                <div class="toolbar">
                    <div title="æ·ºè‰²ä¸»é¡Œï¼ˆå¤ªé™½ï¼‰" id="sunBtn" class="icon-btn">â˜€ï¸</div>
                    <div title="æ·±è‰²ä¸»é¡Œï¼ˆæœˆäº®ï¼‰" id="moonBtn" class="icon-btn">ğŸŒ™</div>
                </div>
            </div>

            <div class="tab-nav" id="tabNav">
                <button class="tab-button active" data-tab="competitions">ğŸ—“ï¸ æ¯”è³½æŸ¥è©¢</button>
                <button class="tab-button" data-tab="timer">â±ï¸ è¨ˆæ™‚å™¨</button>
                <button class="tab-button" data-tab="contact">ğŸ“ è¯çµ¡è³‡è¨Š</button>
            </div>

            <div id="competitionsPanel" class="tab-content active">
                <h2>WCA è³½äº‹åˆ—è¡¨ (å°ç£)</h2>
                <div class="controls">
                    <input id="q" type="text" placeholder="æœå°‹åç¨± / åŸå¸‚ / å¹´ä»½ / ä»£ç¢¼ï¼ˆæ¨¡ç³Šæœå°‹ï¼‰" />
                    <button id="clearBtn" type="button">æ¸…é™¤</button>
                </div>

                <div id="status" class="status">è¼‰å…¥ä¸­â€¦</div>
                <div id="results" class="results"></div>

                <footer>
                    <p class="small meta" style="margin-top: 15px;">
                        å°æé†’ï¼šé»æ“Šæ¯”è³½å¯æŸ¥çœ‹è©³ç´°è³‡è¨Šï¼Œå€’æ•¸ä»¥æ¯”è³½é–‹å§‹æ—¥ç‚ºåŸºæº–ã€‚
                    </p>
                </footer>
            </div>

            <div id="timerPanel" class="tab-content">
                <div id="timerContainer">
                    <div id="timerDisplay">0.00</div>
                    <div id="timerStatus" class="meta small">æŒ‰ä¸‹ **ç©ºç™½éµ** 2 ç§’å¾Œé–‹å§‹è¨ˆæ™‚</div>
                </div>
                <div id="scorePanel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2>æ­·å²æˆç¸¾ (æœ€æ–° 10 ç­†)</h2>
                        <button id="clearTimesBtn" type="button" class="clear-btn-red" title="æ¸…é™¤æ‰€æœ‰æˆç¸¾" style="width: auto; padding: 0 12px;">
                            ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰
                        </button>
                    </div>
                    <div id="timesList">
                        <div class="small meta" style="text-align: center;">å°šç„¡æˆç¸¾ç´€éŒ„ã€‚</div>
                    </div>
                    <div id="statsSummary" class="small meta" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--glass);">
                        ç¸½æˆç¸¾ç­†æ•¸ï¼š0
                    </div>
                </div>
            </div>

            <div id="contactPanel" class="tab-content">
                <h2>å»ºç«‹è€…å€‹äººè¯çµ¡æ–¹å¼</h2>
                <div class="contact-panel">
                    <div class="contact-group">
                        <div class="contact-title">ç¶²ç«™å»ºç«‹èˆ‡ç¶­è­·è€…</div>
                        <div class="info-item">
                            <i class="fab fa-discord" style="color: #5865F2;"></i>
                            <span>Discord é‚€è«‹é€£çµï¼š<a href="https://discord.gg/y2gxYtmXp7" target="_blank">https://discord.gg/y2gxYtmXp7</a></span>
                        </div>
                        <div class="info-item">
                            <i class="far fa-envelope" style="color: #ea4335;"></i>
                            <span>Gmail é›»å­éƒµä»¶ï¼š<a href="mailto:swxhzop@gmail.com">swxhzop@gmail.com</a></span>
                        </div>
                        <div class="note-box">
                            âš ï¸ å‚™è¨»ï¼šæœ¬ç«™ç¶­è­·è€…ç‚ºä¸€åå­¸ç”Ÿï¼Œå› æ­¤å›è¦†å¯èƒ½æœƒæ¯”è¼ƒæ…¢ã€‚<br>
                            **å»ºè­°ä½¿ç”¨ Discord è¯çµ¡ï¼Œæœƒæ¯”è¼ƒå¿«é€Ÿå¾—åˆ°å›è¦†ã€‚**
                        </div>
                    </div>
                    <p class="small" style="margin-top: 20px; color: var(--muted);">
                        å¦‚æœæ‚¨å°æœ¬ç¶²ç«™æœ‰ä»»ä½•å»ºè­°ã€åˆä½œæ„å‘æˆ–æŠ€è¡“å•é¡Œï¼Œæ­¡è¿é€éä»¥ä¸Šæ–¹å¼è¯çµ¡ã€‚
                    </p>
                </div>
            </div>


        </div>
    </div>

    <div id="compModalBackdrop" class="modal-backdrop">
        <div id="compModal" class="modal-content" style="position: relative;">
            <button id="modalCloseBtn" class="modal-close-btn" title="é—œé–‰è¦–çª—">Ã—</button>
            <h2 id="modalTitle" class="modal-title">æ¯”è³½åç¨±</h2>
            <div id="modalInfo" class="modal-info"></div>
            <a id="modalLink" class="modal-link-btn" href="#" target="_blank">å‰å¾€ TWCUBE æ´»å‹•é é¢ â†’</a>
        </div>
    </div>


    <script>
        // WCA API åŸºç¤ URL
        const API_BASE_COMP = 'https://www.worldcubeassociation.org/api/v0/competitions';

        // --- æ ¸å¿ƒ DOM å…ƒç´  ---
        const sunBtn = document.getElementById('sunBtn');
        const moonBtn = document.getElementById('moonBtn');
        const qEl = document.getElementById('q');
        const resultsEl = document.getElementById('results');
        const statusEl = document.getElementById('status');
        const clearBtn = document.getElementById('clearBtn');
        const tabNavEl = document.getElementById('tabNav');
        const competitionsPanelEl = document.getElementById('competitionsPanel');
        const timerPanelEl = document.getElementById('timerPanel');
        const contactPanelEl = document.getElementById('contactPanel');
        const modalBackdrop = document.getElementById('compModalBackdrop');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalTitle = document.getElementById('modalTitle');
        const modalInfo = document.getElementById('modalInfo');
        const modalLink = document.getElementById('modalLink');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerStatus = document.getElementById('timerStatus');
        const timerContainer = document.getElementById('timerContainer');
        const timesListEl = document.getElementById('timesList');
        const clearTimesBtn = document.getElementById('clearTimesBtn');
        const statsSummaryEl = document.getElementById('statsSummary');

        // --- å…¨å±€è®Šæ•¸ ---
        let cache = null;
        let savedTimes = [];
        let startTime;
        let updatedTime;
        let difference = 0;
        let tInterval;
        let running = false;
        let readyToStart = false;
        let statusTimeout;
        let pressStartTime = 0;
        let pressTimer = null;
        const REQUIRED_PRESS_TIME = 2000;


        // ----------------------------------------------------------------
        // --- Tab & ä¸»é¡ŒåŠŸèƒ½ ---
        // ----------------------------------------------------------------

        function switchTab(targetTab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            const targetBtn = document.querySelector(`.tab-button[data-tab="${targetTab}"]`);
            if (targetBtn) targetBtn.classList.add('active');

            if (targetTab === 'competitions') {
                competitionsPanelEl.classList.add('active');
                if (cache) {
                    statusEl.textContent = `å·²è¼‰å…¥ ${cache.length} ç­†æ¯”è³½è³‡æ–™ã€‚`;
                    statusEl.classList.remove('fade-out');
                }
            } else if (targetTab === 'timer') {
                timerPanelEl.classList.add('active');
                if (!running && readyToStart !== 'pending') {
                    setTimerStatus('æŒ‰ä¸‹ **ç©ºç™½éµ** 2 ç§’å¾Œé–‹å§‹è¨ˆæ™‚');
                }
            } else if (targetTab === 'contact') {
                contactPanelEl.classList.add('active');
            }
        }

        tabNavEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-button')) {
                switchTab(e.target.dataset.tab);
            }
        });

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('wca_theme', theme);
        }

        sunBtn.addEventListener('click', () => { setTheme('light'); });
        moonBtn.addEventListener('click', () => { setTheme('dark'); });

        const initialTheme = localStorage.getItem('wca_theme') || 'light';
        setTheme(initialTheme);


        // ----------------------------------------------------------------
        // --- WCA æ¯”è³½æŸ¥è©¢é‚è¼¯ (å¯¦æ™‚ API + Modal) ---
        // ----------------------------------------------------------------

        function formatDateRange(start, end) {
            try {
                const s = new Date(start).toLocaleDateString();
                const e = new Date(end).toLocaleDateString();
                return s === e ? s : `${s} â€” ${e}`;
            } catch (e) {
                return start || ''
            }
        }
        
        // *** æ ¸å¿ƒä¿®æ­£å‡½æ•¸ï¼šé‡çµ„ WCA IDï¼Œå°‡çµå°¾çš„å¹´ä»½ç§»è‡³æœ€å‰ (ç”¨æ–¼ TWCUBE é€£çµ) ***
        function reformatWCAId(wcaId) {
            if (!wcaId) return '';
            // å˜—è©¦åŒ¹é… WCA ID çµå°¾çš„å››ä½æ•¸å­—å¹´ä»½ (ä¾‹å¦‚: TaipeiOpen2025)
            const match = wcaId.match(/(\d{4})$/); 
            
            if (match) {
                const year = match[1]; // æå–å¹´ä»½ (ä¾‹å¦‚: 2025)
                const namePart = wcaId.substring(0, wcaId.length - 4); // æå–åç¨±éƒ¨åˆ† (ä¾‹å¦‚: TaipeiOpen)
                // é‡çµ„æ ¼å¼: [å¹´ä»½][åç¨±]
                return `${year}${namePart}`; // ä¾‹å¦‚: 2025TaipeiOpen
            }
            // å¦‚æœæ²’æœ‰åŒ¹é…åˆ°çµå°¾å¹´ä»½ï¼Œå‰‡ç›´æ¥è¿”å›åŸå§‹ä»£ç¢¼
            return wcaId;
        }
        // *** ä¿®æ­£çµæŸ ***

        async function showModal(c) {
            modalTitle.textContent = c.name;
            modalInfo.innerHTML = `
                <div><strong>åœ°é»ï¼š</strong> ${c.city}, ${c.country_name}</div>
                <div><strong>ä»£ç¢¼ï¼š</strong> ${c.id}</div>
                <div><strong>æ—¥æœŸï¼š</strong> ${formatDateRange(c.start_date, c.end_date)}</div>
                <div><strong>ä¸»è¾¦æ–¹ï¼š</strong> ${c.organizer || c.organizer_name || '-'}</div>
                <div><strong>ç‹€æ…‹ï¼š</strong> ${c.registration_open ? 'âœ… å ±åé–‹æ”¾ä¸­' : 'âŒ å ±åå°šæœªé–‹æ”¾'}</div>
                <div id="modalRecordStatus" style="margin-top: 15px; border-top: 1px solid var(--glass); padding-top: 10px;">
                    <strong>ç´€éŒ„æ©Ÿæœƒï¼š</strong> è¼‰å…¥ä¸­...
                </div>
            `;

            // *** ä¿®æ­£æ‡‰ç”¨ï¼šä½¿ç”¨ reformatWCAId èª¿æ•´ WCA ID æ ¼å¼ä¾†ç”Ÿæˆ TWCUBE é€£çµ ***
            const reformattedId = reformatWCAId(c.id);
            modalLink.href = `https://cubing-tw.net/event/${reformattedId}`;
            // *** ä¿®æ­£çµæŸ ***

            // é¡¯ç¤º Modal
            modalBackdrop.classList.add('is-open');
            document.body.style.overflow = 'hidden';

            // Google æœç´¢åˆ¤æ–·ç´€éŒ„æ©Ÿæœƒ (ç°¡åŒ–æ¨¡æ“¬é‚è¼¯)
            const recordStatusEl = document.getElementById('modalRecordStatus');

            let statusText = 'ğŸ† <strong>åœ‹å®¶ç´€éŒ„ (NR)</strong>ï¼šå¯æŒ‘æˆ°';

            // ç°¡åŒ–æ¨¡æ“¬é‚è¼¯
            if (c.name.toLowerCase().includes('championship')) {
                statusText = 'ğŸŒ <strong>æ´²éš›ç´€éŒ„ (CR)</strong>ï¼šå¯æŒ‘æˆ°<br>' + statusText;
            }
            if (c.name.toLowerCase().includes('world')) {
                statusText = 'ğŸ‘‘ <strong>ä¸–ç•Œç´€éŒ„ (WR)</strong>ï¼šå¯æŒ‘æˆ°<br>' + statusText;
            }

            // æ¨¡æ“¬è¼‰å…¥æ™‚é–“å¾Œé¡¯ç¤ºçµæœ
            await new Promise(r => setTimeout(r, 500));
            recordStatusEl.innerHTML = `<strong>ç´€éŒ„æ©Ÿæœƒï¼š</strong><br>${statusText}`;
        }

        function closeModal() {
            modalBackdrop.classList.remove('is-open');
            document.body.style.overflow = '';
        }

        // é—œé–‰ Modal çš„äº‹ä»¶ç›£è½å™¨
        modalCloseBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                closeModal();
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalBackdrop.classList.contains('is-open')) {
                closeModal();
            }
        });


        function renderItem(c) {
            const div = document.createElement('div');
            div.className = 'item';

            div.addEventListener('click', () => showModal(c));

            // ä¿®æ­£ï¼šå°‡å¹´ä»½æ”¾åœ¨é¡¯ç¤ºåç¨±å‰é¢ (ä¸Šæ¬¡ä¿®æ­£)
            const competitionYear = c.start_date ? new Date(c.start_date).getFullYear() : 'æœªçŸ¥';
            const displayTitle = `${competitionYear} ${c.name}`;

            const left = document.createElement('div');
            left.innerHTML = `
                <div style="font-weight:600; font-size: 16px;">${displayTitle}</div> 
                <div class="meta" style="font-size: 14px; color: var(--text);">
                    ğŸ“ ${c.city||'-'}, ${c.country_name||'-'}
                    <span class="small" style="margin-left: 10px; color: var(--muted);">
                        â€¢ ${formatDateRange(c.start_date, c.end_date)}
                    </span>
                </div>
                <div class="small">ä¸»è¾¦ï¼š${c.organizer||c.organizer_name||'-'}</div>`;

            const cdDiv = document.createElement('div');
            cdDiv.className = 'countdown';
            const lamp = document.createElement('span');
            lamp.className = 'light-lamp';
            const start = new Date(c.start_date);
            const end = new Date(c.end_date);
            let intervalId;

            function updateCountdown() {
                const now = new Date();
                if (now > end) {
                    lamp.className = 'light-lamp red';
                    cdDiv.textContent = 'æ¯”è³½å·²çµæŸ';
                    clearInterval(intervalId);
                    return;
                }

                const diff = start - now;
                if (diff > 0) {
                    const d = Math.floor(diff / 86400000);
                    const h = String(Math.floor(diff % 86400000 / 3600000)).padStart(2, '0');
                    const m = String(Math.floor(diff % 3600000 / 60000)).padStart(2, '0');
                    const s = String(Math.floor(diff % 60000 / 1000)).padStart(2, '0');

                    if (c.registration_open) {
                        lamp.className = 'light-lamp green';
                    } else if (diff < 7 * 86400000) {
                        lamp.className = 'light-lamp yellow';
                    } else {
                        lamp.className = 'light-lamp red';
                    }

                    cdDiv.textContent = `è·é›¢é–‹å§‹ï¼š${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
                } else {
                    lamp.className = 'light-lamp green';
                    cdDiv.textContent = 'æ¯”è³½é€²è¡Œä¸­';
                }

                cdDiv.prepend(lamp);
            }

            updateCountdown();
            intervalId = setInterval(updateCountdown, 1000);

            div.cleanup = () => clearInterval(intervalId);

            div.appendChild(left);
            div.appendChild(cdDiv);

            return div;
        }

        function groupByYear(data) {
            const groups = {};
            data.forEach(c => {
                const year = c.start_date ? new Date(c.start_date).getFullYear() : 'æœªçŸ¥';
                if (!groups[year]) groups[year] = [];
                groups[year].push(c);
            });
            // ç¢ºä¿æœ€æ–°çš„å¹´ä»½åœ¨å‰ (å€’åºæ’åˆ—)
            const sortedYears = Object.keys(groups).sort((a, b) => b - a);
            return { groups, sortedYears };
        }

        // ç¢ºä¿åœ¨å¤±æ•—æ™‚è¿”å›æ¨¡æ“¬æ•¸æ“šï¼Œé¿å… cache = null
        async function fetchAllTaiwanCompetitions() {
            statusEl.classList.add('fade-out');
            await new Promise(r => setTimeout(r, 300));

            statusEl.textContent = 'æ­£åœ¨å¾ WCA å–å¾—å°ç£æ¯”è³½ï¼ˆé€é æŠ“å–â€¦ï¼‰';
            statusEl.classList.remove('fade-out');
            let page = 1;
            const per_page = 100;
            let all = [];
            try {
                while (true) {
                    const url = `${API_BASE_COMP}?country_iso2=TW&per_page=${per_page}&page=${page}`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();
                    if (!Array.isArray(data) || data.length === 0) break;
                    all = all.concat(data);
                    statusEl.textContent = `å·²å–å¾— ${all.length} ç­†ï¼ˆç¬¬ ${page} é ï¼‰...`;
                    if (data.length < per_page) break;
                    page += 1;
                    await new Promise(r => setTimeout(r, 150));
                }
                statusEl.classList.add('fade-out');
                await new Promise(r => setTimeout(r, 300));
                statusEl.textContent = `âœ… å…¨éƒ¨è¼‰å…¥å®Œæˆï¼Œå…± ${all.length} ç­†è³‡æ–™ã€‚`;
                statusEl.classList.remove('fade-out');
                return all;
            } catch (err) {
                statusEl.classList.add('fade-out');
                await new Promise(r => setTimeout(r, 300));
                console.error("WCA API è¼‰å…¥å¤±æ•—:", err);
                statusEl.textContent = 'âŒ ç„¡æ³•å®Œæ•´å–å¾— WCA API (é¡¯ç¤ºæ¨¡æ“¬æ•¸æ“š)ï¼š' + err.message;
                statusEl.classList.remove('fade-out');

                // è¿”å›æ¨¡æ“¬æ•¸æ“šåˆ—è¡¨
                return [{
                    id: 'TaiwanMock2025',
                    name: 'WCA æ•¸æ“šè¼‰å…¥å¤±æ•— - æ¨¡æ“¬æ¯”è³½',
                    city: 'è«‹é€éç¶²å€å­˜å–',
                    country_name: 'Taiwan',
                    start_date: '2025-12-15',
                    end_date: '2025-12-17',
                    organizer_name: 'Mock Org',
                    registration_open: true
                }, {
                    id: 'TaiwanMock2024',
                    name: 'å·²çµæŸæ¨¡æ“¬æ¯”è³½',
                    city: 'è«‹é€éç¶²å€å­˜å–',
                    country_name: 'Taiwan',
                    start_date: '2024-05-01',
                    end_date: '2024-05-03',
                    organizer_name: 'Mock Org',
                    registration_open: false
                }];
            }
        }


        function renderGroups(groupsObj, q) {
            Array.from(resultsEl.querySelectorAll('.item')).forEach(item => {
                if (item.cleanup) item.cleanup();
            });

            resultsEl.innerHTML = '';
            const {
                groups,
                sortedYears
            } = groupsObj;
            let totalFilteredCount = 0;

            sortedYears.forEach((year, yearIndex) => {
                const yearDiv = document.createElement('div');
                yearDiv.className = 'year-group';
                const title = document.createElement('div');
                title.className = 'year-title';
                title.innerHTML = `ğŸ“… ${year} å¹´`;
                title.style.animationDelay = `${yearIndex * 0.1}s`;

                const list = document.createElement('div');

                const items = groups[year].filter(c => {
                    if (!q) return true;
                    const ql = q.toLowerCase();
                    return (c.name && c.name.toLowerCase().includes(ql)) || (c.city && c.city.toLowerCase().includes(ql)) || (c.id && c.id.toLowerCase().includes(ql)) || (c.start_date && new Date(c.start_date).getFullYear().toString().includes(ql));
                });

                if (items.length > 0) {
                    yearDiv.appendChild(title); // æœ‰é …ç›®æ‰é¡¯ç¤ºå¹´ä»½æ¨™é¡Œ
                    totalFilteredCount += items.length;
                    items.sort((a, b) => new Date(b.start_date) - new Date(a.start_date)).forEach(c => list.appendChild(renderItem(c)));
                    yearDiv.appendChild(list);
                    resultsEl.appendChild(yearDiv);
                }
            });

            if (totalFilteredCount === 0 && cache && cache.length > 0) {
                resultsEl.innerHTML = '<div class="small meta" style="text-align: center; margin-top: 30px;">ï¼ˆæ²’æœ‰æ‰¾åˆ°ç¬¦åˆã€Œ' + q + 'ã€çš„æ¯”è³½ï¼‰</div>';
            } else if (cache === null) {
                resultsEl.innerHTML = '<div class="small meta" style="text-align: center; margin-top: 30px;">ï¼ˆæ¯”è³½è³‡æ–™è¼‰å…¥ä¸­æˆ–è¼‰å…¥å¤±æ•—ï¼‰</div>';
            }
        }

        let searchTimer = null;

        function liveSearch() {
            const q = qEl.value.trim();
            if (!cache) return;
            clearTimeout(searchTimer);
            searchTimer = setTimeout(async () => {
                statusEl.classList.add('fade-out');
                await new Promise(r => setTimeout(r, 300));

                renderGroups(groupByYear(cache), q);
                const filteredCount = Array.from(resultsEl.querySelectorAll('.item')).length;
                statusEl.textContent = `å·²éæ¿¾å‡º ${filteredCount} ç­†çµæœï¼ˆæœå°‹ï¼š\"${q||'å…¨éƒ¨'}\"ï¼‰`;
                statusEl.classList.remove('fade-out');
            }, 180);
        }

        qEl.addEventListener('input', liveSearch);
        clearBtn.addEventListener('click', async () => {
            qEl.value = '';
            qEl.focus();
            if (cache) {
                statusEl.classList.add('fade-out');
                await new Promise(r => setTimeout(r, 300));

                renderGroups(groupByYear(cache), '');
                statusEl.textContent = `å·²æ¸…é™¤ç¯©é¸ï¼Œå…± ${cache.length} ç­†è³‡æ–™ã€‚`;
                statusEl.classList.remove('fade-out');
            }
        });


        // ----------------------------------------------------------------
        // --- é­”æ–¹è¨ˆæ™‚å™¨åŠŸèƒ½ (é•·æŒ‰ 2 ç§’ã€å‹•ç•«èˆ‡å„²å­˜) ---
        // ----------------------------------------------------------------

        function getFormattedTime(time) {
            const ms = time % 1000;
            const s = Math.floor(time / 1000) % 60;
            const m = Math.floor(time / 60000) % 60;

            const formattedMs = String(Math.floor(ms / 10)).padStart(2, '0');
            const formattedS = String(s).padStart(2, '0');
            const formattedM = m > 0 ? `${m}:` : '';

            return `${formattedM}${formattedS}.${formattedMs}`;
        }

        function setTimerStatus(message) {
            clearTimeout(statusTimeout);
            timerStatus.classList.add('fade-out');
            statusTimeout = setTimeout(() => {
                timerStatus.innerHTML = message;
                timerStatus.classList.remove('fade-out');
            }, 200);
        }

        function startTimer() {
            startTime = new Date().getTime();
            tInterval = setInterval(updateTime, 10);
            running = true;
            setTimerStatus('è¨ˆæ™‚ä¸­... æŒ‰ä¸‹ **ç©ºç™½éµ** åœæ­¢');
        }

        function stopTimer() {
            clearInterval(tInterval);
            running = false;
            readyToStart = false;

            if (difference > 0) {
                savedTimes.push(difference);
                saveTimes();
                renderTimes();
            }

            setTimerStatus(`å®Œæˆï¼ç”¨æ™‚ **${getFormattedTime(difference)}**ã€‚æŒ‰ä¸‹ **Enter** é‡è¨­ï¼Œæˆ– **ç©ºç™½éµ** é–‹å§‹æ–°ä¸€è¼ªã€‚`);
        }

        function updateTime() {
            updatedTime = new Date().getTime();
            difference = updatedTime - startTime;
            timerDisplay.textContent = getFormattedTime(difference);

            timerDisplay.style.animation = 'none';
            void timerDisplay.offsetWidth;
            timerDisplay.style.animation = 'timer-digit-pop 0.1s ease-out';
        }

        function resetTimer() {
            clearInterval(tInterval);
            clearTimeout(pressTimer);
            pressTimer = null;
            running = false;
            difference = 0;
            timerDisplay.textContent = '0.00';
            setTimerStatus('æŒ‰ä¸‹ **ç©ºç™½éµ** 2 ç§’å¾Œé–‹å§‹è¨ˆæ™‚');
            timerDisplay.classList.remove('ready');
            readyToStart = false;
            timerDisplay.style.animation = 'none';
        }

        // --- éµç›¤æ§åˆ¶ (é•·æŒ‰ 2 ç§’å•Ÿå‹•é‚è¼¯) ---
        document.addEventListener('keydown', (e) => {
            if (!timerPanelEl.classList.contains('active') || document.activeElement.tagName === 'INPUT') {
                return;
            }

            if (e.key === ' ' || e.code === 'Space') {
                e.preventDefault();

                if (running) {
                    stopTimer();
                    return;
                }

                if (readyToStart === false) {

                    timerContainer.classList.add('key-pressed');
                    pressStartTime = new Date().getTime();
                    timerDisplay.textContent = '0.00';
                    setTimerStatus('æŒçºŒæŒ‰ä½ **ç©ºç™½éµ** 2 ç§’ä»¥æº–å‚™...');

                    pressTimer = setTimeout(() => {
                        readyToStart = true;
                        timerDisplay.classList.add('ready');
                        setTimerStatus('ğŸŸ¢ READY! é¬†é–‹é–‹å§‹è¨ˆæ™‚ã€‚');
                    }, REQUIRED_PRESS_TIME);

                    readyToStart = 'pending';
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                timerContainer.classList.add('key-pressed');
                resetTimer();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!timerPanelEl.classList.contains('active') || document.activeElement.tagName === 'INPUT') {
                return;
            }

            timerContainer.classList.remove('key-pressed');

            if (e.key === ' ' || e.code === 'Space') {
                e.preventDefault();

                if (running) {
                    return;
                }

                clearTimeout(pressTimer);
                pressTimer = null;

                if (readyToStart === true) {
                    startTimer();
                    timerDisplay.classList.remove('ready');
                    readyToStart = false;

                } else if (readyToStart === 'pending' && new Date().getTime() - pressStartTime < REQUIRED_PRESS_TIME) {
                    resetTimer();
                    setTimerStatus('æœªé” 2 ç§’ã€‚è«‹æŒçºŒæŒ‰ä½ **ç©ºç™½éµ** 2 ç§’ä»¥å•Ÿå‹•ã€‚');
                }
            }
            if (e.key === 'Enter') {
                timerContainer.classList.remove('key-pressed');
            }
        });


        // ----------------------------------------------------------------
        // --- æˆç¸¾å„²å­˜èˆ‡é¡¯ç¤ºé‚è¼¯ ---
        // ----------------------------------------------------------------

        function loadTimes() {
            try {
                const json = localStorage.getItem('twcube_times');
                savedTimes = json ? JSON.parse(json) : [];
            } catch (e) {
                console.error("è¼‰å…¥æˆç¸¾å¤±æ•—", e);
                savedTimes = [];
            }
            renderTimes();
        }

        function saveTimes() {
            localStorage.setItem('twcube_times', JSON.stringify(savedTimes));
        }

        function formatTimeValue(timeInMs) {
            const ms = timeInMs % 1000;
            const s = Math.floor(timeInMs / 1000) % 60;
            const m = Math.floor(timeInMs / 60000) % 60;

            const formattedMs = String(Math.floor(ms / 10)).padStart(2, '0');
            const formattedS = String(s).padStart(1, '0');
            const formattedM = m > 0 ? `${m}:` : '';

            return `${formattedM}${formattedS}.${formattedMs}`;
        }

        function renderTimes() {
            timesListEl.innerHTML = '';

            if (savedTimes.length === 0) {
                timesListEl.innerHTML = '<div class="small meta" style="text-align: center;">å°šç„¡æˆç¸¾ç´€éŒ„ã€‚</div>';
                statsSummaryEl.textContent = 'ç¸½æˆç¸¾ç­†æ•¸ï¼š0';
                return;
            }

            const sorted = [...savedTimes].sort((a, b) => a - b);
            const bestTime = sorted[0];
            const totalTime = savedTimes.reduce((sum, time) => sum + time, 0);
            const averageTime = totalTime / savedTimes.length;

            statsSummaryEl.innerHTML = `
                ç¸½ç­†æ•¸ï¼š**${savedTimes.length}** | 
                æœ€ä½³å–®æ¬¡ (PB)ï¼š**${formatTimeValue(bestTime)}** | 
                å¹³å‡ï¼š**${formatTimeValue(averageTime)}**
            `;

            const displayTimes = savedTimes.slice(-10).reverse();

            displayTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'time-item';
                const rank = savedTimes.length - index;

                if (time === bestTime) {
                    timeItem.classList.add('best');
                }

                timeItem.innerHTML = `
                    <span class="rank">#${rank}</span>
                    <span>æˆç¸¾:</span>
                    <span class="value">${formatTimeValue(time)}</span>
                `;
                timesListEl.appendChild(timeItem);
            });
        }

        clearTimesBtn.addEventListener('click', () => {
            if (confirm('æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²æˆç¸¾å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ï¼')) {
                savedTimes = [];
                saveTimes();
                renderTimes();
                resetTimer();
            }
        });


        // ----------------------------------------------------------------
        // --- é é¢åˆå§‹åŒ– ---
        // ----------------------------------------------------------------

        (async () => {
            // 1. è¼‰å…¥æ¯”è³½è³‡æ–™
            cache = await fetchAllTaiwanCompetitions();
            renderGroups(groupByYear(cache), '');

            // 2. è¼‰å…¥æˆç¸¾è³‡æ–™
            loadTimes();

            // 3. é è¨­é¡¯ç¤ºæ¯”è³½é¢æ¿
            switchTab('competitions');
        })();
    </script>

</body>

</html>
